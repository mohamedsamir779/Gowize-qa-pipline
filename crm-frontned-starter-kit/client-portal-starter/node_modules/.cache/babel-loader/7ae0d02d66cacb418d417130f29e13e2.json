{"ast":null,"code":"import{useRef,useEffect,useState}from\"react\";import{useSelector}from\"react-redux\";import{createChart,CrosshairMode}from\"lightweight-charts\";import{BigNumber}from\"bignumber.js\";import{fetchOHLCV}from\"../../../apis/klines\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const ZEROS=\"0000.0000\";const Chart=_ref=>{var _OHLC$open,_OHLC$high,_OHLC$low,_OHLC$close;let{klines,symbol,timeframe,socketKlines}=_ref;const[OHLC,setOHLC]=useState(undefined);const chartContainerRef=useRef();const chart=useRef();const resizeObserver=useRef();const appTheme=useSelector(state=>state.Layout.layoutMode);useEffect(()=>{chart.current=createChart(chartContainerRef.current,{layout:{background:{color:\"transparent\"}},width:chartContainerRef.current.clientWidth,height:375,crosshair:{mode:CrosshairMode.Normal,color:\"#758696\"},timeScale:{timeVisible:true},localization:{priceFormatter:price=>price<1?BigNumber(price).toFixed(5):BigNumber(price).toFixed(3)}});},[]);useEffect(()=>{const candleSeries=chart.current.addCandlestickSeries({upColor:\"#4bffb5\",downColor:\"#ff4976\",borderDownColor:\"#ff4976\",borderUpColor:\"#4bffb5\",wickDownColor:\"#838ca1\",wickUpColor:\"#838ca1\"});if(klines.length>0){candleSeries.setData(klines);// Get OHLC data on mouse move\nchart.current.subscribeCrosshairMove(param=>{setOHLC(param.seriesPrices.get(candleSeries));});// Infinite history loading\nconst timeScale=chart.current.timeScale();let timer=null;timeScale.subscribeVisibleLogicalRangeChange(()=>{if(timer!==null)return;// kline time in state is in secs, but backend expects it in ms\nlet since=(klines[0].time-60*60*24)*1000;timer=setTimeout(async()=>{var logicalRange=timeScale.getVisibleLogicalRange();if(logicalRange!==null){const barsInfo=candleSeries.barsInLogicalRange(logicalRange);if(barsInfo!==null&&barsInfo.barsBefore<25&&barsInfo.barsAfter!==0){let payload={since,limit:500,symbol,timeframe:timeframe.key};const{data}=await fetchOHLCV({payload});if((data===null||data===void 0?void 0:data.length)>0){klines=[...data,klines];candleSeries.setData(data);}}}timer=null;},50);});// realtime emulation\nvar tick=klines[klines.length-1].time+timeframe.value;if(socketKlines.length>0){var candleUpdateTime=setInterval(()=>{const lastCandle=socketKlines[socketKlines.length-1];if(lastCandle.time>tick){tick+=timeframe.value;}lastCandle.time=tick;candleSeries.update(lastCandle);},50);}}return()=>clearInterval(candleUpdateTime);},[klines]);// chart colors\nuseEffect(()=>{const theme={light:{layout:{textColor:\"rgb(89, 98, 105)\"},grid:{vertLines:{color:\"#ced4da\"},horzLines:{color:\"#ced4da\"}},priceScale:{borderColor:\"#ced4da\"},timeScale:{borderColor:\"#ced4da\"}},dark:{layout:{textColor:\"rgb(113, 122, 134)\"},grid:{vertLines:{color:\"#44494f\"},horzLines:{color:\"#44494f\"}},priceScale:{borderColor:\"#44494f\"},timeScale:{borderColor:\"#44494f\"}}};chart.current.applyOptions(appTheme===\"light\"?theme.light:theme.dark);},[appTheme]);// Resize chart on container resizes.\nuseEffect(()=>{resizeObserver.current=new ResizeObserver(entries=>{const{width,height}=entries[0].contentRect;chart.current.applyOptions({width,height});setTimeout(()=>{chart.current.timeScale().fitContent();},0);});resizeObserver.current.observe(chartContainerRef.current);return()=>resizeObserver.current.disconnect();},[]);return/*#__PURE__*/_jsxs(\"div\",{className:\"position-relative\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"position-absolute end-0 me-2 \".concat(!OHLC?\"text-secondary\":(OHLC===null||OHLC===void 0?void 0:OHLC.open)>(OHLC===null||OHLC===void 0?void 0:OHLC.close)?\"text-danger\":\"text-success\"),style:{top:\"-30px\"},children:\"O: \".concat((_OHLC$open=OHLC===null||OHLC===void 0?void 0:OHLC.open)!==null&&_OHLC$open!==void 0?_OHLC$open:ZEROS,\" H: \").concat((_OHLC$high=OHLC===null||OHLC===void 0?void 0:OHLC.high)!==null&&_OHLC$high!==void 0?_OHLC$high:ZEROS,\" L: \").concat((_OHLC$low=OHLC===null||OHLC===void 0?void 0:OHLC.low)!==null&&_OHLC$low!==void 0?_OHLC$low:ZEROS,\" C: \").concat((_OHLC$close=OHLC===null||OHLC===void 0?void 0:OHLC.close)!==null&&_OHLC$close!==void 0?_OHLC$close:ZEROS)}),/*#__PURE__*/_jsx(\"div\",{ref:chartContainerRef,className:\"chart-container\"})]});};export default Chart;","map":{"version":3,"names":["useRef","useEffect","useState","useSelector","createChart","CrosshairMode","BigNumber","fetchOHLCV","jsx","_jsx","jsxs","_jsxs","ZEROS","Chart","_ref","_OHLC$open","_OHLC$high","_OHLC$low","_OHLC$close","klines","symbol","timeframe","socketKlines","OHLC","setOHLC","undefined","chartContainerRef","chart","resizeObserver","appTheme","state","Layout","layoutMode","current","layout","background","color","width","clientWidth","height","crosshair","mode","Normal","timeScale","timeVisible","localization","priceFormatter","price","toFixed","candleSeries","addCandlestickSeries","upColor","downColor","borderDownColor","borderUpColor","wickDownColor","wickUpColor","length","setData","subscribeCrosshairMove","param","seriesPrices","get","timer","subscribeVisibleLogicalRangeChange","since","time","setTimeout","logicalRange","getVisibleLogicalRange","barsInfo","barsInLogicalRange","barsBefore","barsAfter","payload","limit","key","data","tick","value","candleUpdateTime","setInterval","lastCandle","update","clearInterval","theme","light","textColor","grid","vertLines","horzLines","priceScale","borderColor","dark","applyOptions","ResizeObserver","entries","contentRect","fitContent","observe","disconnect","className","children","concat","open","close","style","top","high","low","ref"],"sources":["/home/ubuntu/king/portal/client-portal-starter/src/pages/Crypto/Exchange/Chart.js"],"sourcesContent":["import {\n  useRef, useEffect, useState\n} from \"react\";\nimport { useSelector } from \"react-redux\";\nimport { createChart, CrosshairMode } from \"lightweight-charts\";\nimport { BigNumber } from \"bignumber.js\";\nimport { fetchOHLCV } from \"../../../apis/klines\";\n\nconst ZEROS = \"0000.0000\";\nconst Chart = ({ klines, symbol, timeframe, socketKlines }) => {\n  const [OHLC, setOHLC] = useState(undefined);\n  const chartContainerRef = useRef();\n  const chart = useRef();\n  const resizeObserver = useRef();\n  const appTheme = useSelector((state) => state.Layout.layoutMode);\n\n  useEffect(() => {\n    chart.current = createChart(chartContainerRef.current, {\n      layout: {\n        background: { color: \"transparent\" }\n      },\n      width: chartContainerRef.current.clientWidth,\n      height: 375,\n      crosshair: {\n        mode: CrosshairMode.Normal,\n        color: \"#758696\",\n      },\n      timeScale: {\n        timeVisible: true,\n      },\n      localization: {\n        priceFormatter: (price) =>\n          price < 1 ? BigNumber(price).toFixed(5) : BigNumber(price).toFixed(3)\n      }\n    });\n  }, []);\n\n  useEffect(() => {\n    const candleSeries = chart.current.addCandlestickSeries({\n      upColor: \"#4bffb5\",\n      downColor: \"#ff4976\",\n      borderDownColor: \"#ff4976\",\n      borderUpColor: \"#4bffb5\",\n      wickDownColor: \"#838ca1\",\n      wickUpColor: \"#838ca1\",\n    });\n\n    if (klines.length > 0) {\n      candleSeries.setData(klines);\n\n      // Get OHLC data on mouse move\n      chart.current.subscribeCrosshairMove((param) => {\n        setOHLC(param.seriesPrices.get(candleSeries));\n      });\n\n      // Infinite history loading\n      const timeScale = chart.current.timeScale();\n      let timer = null;\n      timeScale.subscribeVisibleLogicalRangeChange(() => {\n        if (timer !== null) return;\n        // kline time in state is in secs, but backend expects it in ms\n        let since = (klines[0].time - 60 * 60 * 24) * 1000;\n        timer = setTimeout(async () => {\n          var logicalRange = timeScale.getVisibleLogicalRange();\n          if (logicalRange !== null) {\n            const barsInfo = candleSeries.barsInLogicalRange(logicalRange);\n            if (barsInfo !== null && barsInfo.barsBefore < 25 && barsInfo.barsAfter !== 0) {\n              let payload = {\n                since,\n                limit: 500,\n                symbol,\n                timeframe: timeframe.key,\n              };\n              const { data } = await fetchOHLCV({ payload });\n              if (data?.length > 0) {\n                klines = [...data, klines];\n                candleSeries.setData(data);\n              }\n            }\n          }\n          timer = null;\n        }, 50);\n      });\n\n      // realtime emulation\n      var tick = klines[klines.length - 1].time + timeframe.value;\n      if (socketKlines.length > 0) {\n        var candleUpdateTime = setInterval(() => {\n          const lastCandle = socketKlines[socketKlines.length - 1];\n          if (lastCandle.time > tick) {\n            tick += timeframe.value;\n          }\n          lastCandle.time = tick;\n          candleSeries.update(lastCandle);\n        }, 50);\n      }\n    }\n    return () => clearInterval(candleUpdateTime);\n  }, [klines]);\n\n  // chart colors\n  useEffect(() => {\n    const theme = {\n      light: {\n        layout: {\n          textColor: \"rgb(89, 98, 105)\",\n        },\n        grid: {\n          vertLines: {\n            color: \"#ced4da\",\n          },\n          horzLines: {\n            color: \"#ced4da\",\n          },\n        },\n        priceScale: {\n          borderColor: \"#ced4da\",\n        },\n        timeScale: {\n          borderColor: \"#ced4da\",\n        },\n      },\n      dark: {\n        layout: {\n          textColor: \"rgb(113, 122, 134)\",\n        },\n        grid: {\n          vertLines: {\n            color: \"#44494f\",\n          },\n          horzLines: {\n            color: \"#44494f\",\n          },\n        },\n        priceScale: {\n          borderColor: \"#44494f\",\n        },\n        timeScale: {\n          borderColor: \"#44494f\",\n        },\n      },\n    };\n    chart.current.applyOptions(appTheme === \"light\" ? theme.light : theme.dark);\n  }, [appTheme]);\n\n  // Resize chart on container resizes.\n  useEffect(() => {\n    resizeObserver.current = new ResizeObserver(entries => {\n      const { width, height } = entries[0].contentRect;\n      chart.current.applyOptions({\n        width,\n        height\n      });\n      setTimeout(() => {\n        chart.current.timeScale().fitContent();\n      }, 0);\n    });\n    resizeObserver.current.observe(chartContainerRef.current);\n    return () => resizeObserver.current.disconnect();\n  }, []);\n\n  return (\n    <div className=\"position-relative\">\n      <p className={`position-absolute end-0 me-2 ${!OHLC ? \"text-secondary\" : OHLC?.open > OHLC?.close ? \"text-danger\" : \"text-success\"}`}\n        style={{ top: \"-30px\" }}>\n        {`O: ${OHLC?.open ?? ZEROS} H: ${OHLC?.high ?? ZEROS} L: ${OHLC?.low ?? ZEROS} C: ${OHLC?.close ?? ZEROS}`}\n      </p>\n      <div ref={chartContainerRef} className=\"chart-container\" />\n    </div>\n  );\n};\n\nexport default Chart;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}